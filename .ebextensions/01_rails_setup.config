option_settings:
  aws:elasticbeanstalk:command:
    Timeout: 2000
  aws:elasticbeanstalk:application:environment:
    BUNDLE_PATH: "vendor/bundle"
    BUNDLE_WITHOUT: "test:development"
    BUNDLE_DISABLE_SHARED_GEMS: 1
    RAILS_SKIP_MIGRATIONS: true
    RAILS_SKIP_ASSET_COMPILATION: true
    LOGGING: debug

packages:
  yum:
    git: []
    curl: []
    wget: []
    openssl-devel: []

commands:
  01_postgres_activate:
    command: sudo amazon-linux-extras enable postgresql10
  02_postgres_install:
    command: sudo yum install -y postgresql-devel
  03_node_download:
    cwd: /tmp
    command: "curl -sL https://rpm.nodesource.com/setup_14.x | sudo bash -"
    ignoreErrors: true
  04_node_install:
    cwd: /tmp
    command: "sudo yum install nodejs -y"
    ignoreErrors: true
  05_yarn_download:
    cwd: /tmp
    test: '[ ! -f /usr/bin/yarn ] && echo "yarn not installed"'
    command: "sudo wget https://dl.yarnpkg.com/rpm/yarn.repo -O /etc/yum.repos.d/yarn.repo"
    ignoreErrors: true
  06_yarn_install:
    cwd: /tmp
    test: '[ ! -f /usr/bin/yarn ] && echo "yarn not installed"'
    command: "sudo yum install yarn -y"
    ignoreErrors: true

container_commands:
  16_bundle_install:
    command: "bundle _2.3.10_ install"
  17_yarn_install:
    command: "yarn install --check-files --force --production"
  18_asset_precompile:
    command: "NODE_ENV=production bundle exec rails assets:precompile --trace"
  19_webpacker_compile:
    command: "NODE_ENV=production bundle exec rails webpacker:compile --trace"
  20_db_migrate:
    command: "bundle exec rails db:migrate"
